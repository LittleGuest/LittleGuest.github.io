<!DOCTYPE html>
<html lang="en"><head>
    <title>gopher9527&#39;s Blog</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#000084" />
    <link rel="icon" href="https://littleguest.github.io//favicon.ico">
    <link rel="canonical" href="https://littleguest.github.io/">
    
    
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="https://littleguest.github.io/">gopher9527&#39;s Blog</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                    
                        
                            <li>
                                <a href="/about/">
                                    
                                    <span>About</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/posts/">
                                    
                                    <span>Posts</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/links/">
                                    
                                    <span>Links</span>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>
</nav><div id="content" class="container">

<div class="row-fluid navmargin">
    <div class="page-header">
        <h1>Rust之旅-错误处理 - Tue, Jan 12, 2021</h1>
    </div>
    <p class="lead">Rust之旅-错误处理</p>
    <h2 id="rust中的错误处理">Rust中的错误处理</h2>
<p>在 <code>Java</code> 中处理异常一般有以下几种方式：</p>
<ul>
<li>使用 <code>try-catch</code> 捕获异常</li>
<li>通过 <code>throw</code> 的方式向上抛异常</li>
<li>在web中全局拦截异常</li>
</ul>
<p>当然还有其他方式处理异常，这里就不一一列举了。</p>
<p>好了，回归正题，</p>
<p><strong>那么在 <code>Rust</code> 中是怎么处理错误的呢？</strong></p>
<p>来讲怎么处理错误之前，我们首先需要了解标准库中的 <code>std::result::Result</code> 这个枚举</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">#[must_use = </span><span style="color:#e6db74">&#34;this `Result` may be an `Err` variant, which should be handled&#34;</span><span style="color:#75715e">]</span>
<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> Result<span style="color:#f92672">&lt;</span>T, E<span style="color:#f92672">&gt;</span> {
    Ok(T),
    Err(E),
}
</code></pre></div><p>它是用来返回错误和传播错误的，<code>Ok(T)</code> 代表成功并且包含一个成功值, <code>Err(E)</code> 代表错误并且包含一个错误值， <code>#[must_use]</code> 属性表示返回值 <code>Result</code> 需要被处理，否则编译器会给出警告；</p>
<ul>
<li>
<p><strong>最简单粗暴的方式就是直接 unwrap</strong></p>
<ul>
<li><code>unwrap</code> 如果出现错误，直接 panic，一般不推荐使用；</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">assert_eq<span style="color:#f92672">!</span>(Ok::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span>(<span style="color:#ae81ff">1</span>).unwrap(), <span style="color:#ae81ff">1</span>);
Err::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;error&#34;</span>).unwrap(); <span style="color:#75715e">// panic
</span></code></pre></div><ul>
<li><code>unwrap_or</code> 如果出现错误，返回给出的值；</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">assert_eq<span style="color:#f92672">!</span>(Err::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;error&#34;</span>).unwrap_or(<span style="color:#ae81ff">1</span>), <span style="color:#ae81ff">1</span>);
</code></pre></div><ul>
<li><code>unwrap_or_else</code> 如果出现错误，返回闭包计算出的值；</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">assert_eq<span style="color:#f92672">!</span>(Err::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;error&#34;</span>).unwrap_or_else(<span style="color:#f92672">|</span>_<span style="color:#f92672">|</span> <span style="color:#ae81ff">1</span>), <span style="color:#ae81ff">1</span>);

<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">count</span>(x: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; <span style="color:#66d9ef">usize</span> {
    x.len()
}
assert_eq<span style="color:#f92672">!</span>(Err::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span>, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;error&#34;</span>).unwrap_or_else(count), <span style="color:#ae81ff">5</span>);  
</code></pre></div><ul>
<li><code>unwrap_or_default</code> 如果出现错误，返回改类型的默认值，否则返回 <code>Ok(T)</code> 包含的值；</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">assert_eq<span style="color:#f92672">!</span>(Err::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">i32</span>, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;error&#34;</span>).unwrap_or_default(), <span style="color:#ae81ff">0</span>);
assert_eq<span style="color:#f92672">!</span>(Err::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">bool</span>, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;error&#34;</span>).unwrap_or_default(), <span style="color:#66d9ef">false</span>);
</code></pre></div></li>
<li>
<p><strong>或者 expect</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">Err::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">str</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;error&#34;</span>).expect(<span style="color:#e6db74">&#34;panic&#34;</span>); <span style="color:#75715e">// ...thread &#39;main&#39; panicked at &#39;panic: &#34;error&#34;&#39;,...
</span></code></pre></div></li>
</ul>
<p>我们想要快速获取 <code>Ok(T)</code> 中的值，常用的就是以上这几种 <code>Result</code> 的方法，接下来我们尝试其它途径来处理错误；</p>
<ul>
<li>
<p><strong>使用 match 模式匹配</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> std::fs::File;
<span style="color:#66d9ef">use</span> std::io::Read;

<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> file <span style="color:#f92672">=</span> File::open(<span style="color:#e6db74">&#34;./setting.toml&#34;</span>);
    <span style="color:#66d9ef">match</span> file {
        Ok(<span style="color:#66d9ef">mut</span> f) <span style="color:#f92672">=&gt;</span> {
            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> buf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>.to_string();
            <span style="color:#66d9ef">let</span> read <span style="color:#f92672">=</span> f.read_to_string(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> buf);
            <span style="color:#66d9ef">match</span> read {
                Ok(_) <span style="color:#f92672">=&gt;</span> {}
                Err(e) <span style="color:#f92672">=&gt;</span> eprintln<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;read err: {}&#34;</span>, e),
            }
        }
        Err(e) <span style="color:#f92672">=&gt;</span> eprintln<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;open err: {}&#34;</span>, e),
    }
}
</code></pre></div><p>当我们需要处理多个错误时，使用 <code>match</code> 匹配就有点啰嗦了。</p>
</li>
<li>
<p><strong>传播错误</strong>
我们可以使用 <code>?</code> 操作符来简化 <code>match</code> 模式匹配</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> std::fs::File;
<span style="color:#66d9ef">use</span> std::io::Read;

<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), std::io::Error<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> file <span style="color:#f92672">=</span> File::open(<span style="color:#e6db74">&#34;./setting.toml&#34;</span>)<span style="color:#f92672">?</span>;
    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> buf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>.to_string();
    <span style="color:#66d9ef">let</span> _ <span style="color:#f92672">=</span> file.read_to_string(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> buf)<span style="color:#f92672">?</span>;
    Ok(())
}
</code></pre></div><p>可以看到使用 <code>?</code> 极大的简化了我们的代码，当然现在我们只返回来一种错误，接下来我们看看是怎样返回多种错误的；</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> std::fs::File;
<span style="color:#66d9ef">use</span> std::io::Read;

<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), Box<span style="color:#f92672">&lt;</span>dyn std::error::Error<span style="color:#f92672">&gt;&gt;</span> {
    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> file <span style="color:#f92672">=</span> File::open(<span style="color:#e6db74">&#34;./Cargo.toml&#34;</span>)<span style="color:#f92672">?</span>;
    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> buf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>.to_string();
    <span style="color:#66d9ef">let</span> _ <span style="color:#f92672">=</span> file.read_to_string(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> buf)<span style="color:#f92672">?</span>;

    <span style="color:#e6db74">&#34;a&#34;</span>.parse::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">i32</span><span style="color:#f92672">&gt;</span>()<span style="color:#f92672">?</span>;
    Ok(())
}
</code></pre></div></li>
<li>
<p><strong>自定义错误</strong>
开始自定义错误之前，需要了解标准库 <code>std::error::Error</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Error: <span style="color:#a6e22e">Debug</span> <span style="color:#f92672">+</span> Display {
  <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">source</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span>(dyn Error <span style="color:#f92672">+</span> &#39;static)<span style="color:#f92672">&gt;</span> { ... }
  <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">backtrace</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span>Backtrace<span style="color:#f92672">&gt;</span> { ... }
  <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">description</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span> { ... }
  <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">cause</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span>dyn Error<span style="color:#f92672">&gt;</span> { ... }
}
</code></pre></div><p>当我们自定义错误时，只需要管 <code>source</code> 这个方法就行了， <code>description</code> 和 <code>cause</code> 已经废弃了，<code>backtrace</code> 在 <code>nightly</code> 版本中还是实验性的（我的版本是 1.49.0）；</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> std::fmt::{Debug, Display, Formatter};
<span style="color:#66d9ef">use</span> std::fs::File;
<span style="color:#66d9ef">use</span> std::io::{Error, Read};
<span style="color:#66d9ef">use</span> std::num::ParseIntError;
<span style="color:#66d9ef">use</span> std::<span style="color:#66d9ef">str</span>::Utf8Error;

<span style="color:#75715e">#[derive(Debug)]</span>
<span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">CustomError</span> {
    IoErr,
    ParseIntError(ParseIntError),
    Utf8Error(Utf8Error),
}

<span style="color:#66d9ef">impl</span> Display <span style="color:#66d9ef">for</span> CustomError {
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fmt</span>(<span style="color:#f92672">&amp;</span>self, f: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Formatter<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">&#39;_</span><span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#a6e22e">std</span>::fmt::Result {
        <span style="color:#66d9ef">match</span> self {
            CustomError::IoErr <span style="color:#f92672">=&gt;</span> write<span style="color:#f92672">!</span>(f, <span style="color:#e6db74">&#34;io error&#34;</span>),
            CustomError::ParseIntError(_) <span style="color:#f92672">=&gt;</span> write<span style="color:#f92672">!</span>(f, <span style="color:#e6db74">&#34;parse int error&#34;</span>),
            CustomError::Utf8Error(_) <span style="color:#f92672">=&gt;</span> write<span style="color:#f92672">!</span>(f, <span style="color:#e6db74">&#34;utf8 error&#34;</span>),
        }
    }
}

<span style="color:#66d9ef">impl</span> std::error::Error <span style="color:#66d9ef">for</span> CustomError {
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">source</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Option<span style="color:#f92672">&lt;&amp;</span>(dyn std::error::Error <span style="color:#f92672">+</span> &#39;static)<span style="color:#f92672">&gt;</span> {
        <span style="color:#66d9ef">match</span> self {
            CustomError::IoErr <span style="color:#f92672">=&gt;</span> None,
            CustomError::ParseIntError(e) <span style="color:#f92672">=&gt;</span> Some(e),
            CustomError::Utf8Error(e) <span style="color:#f92672">=&gt;</span> Some(e),
        }
    }
}

<span style="color:#66d9ef">impl</span> From<span style="color:#f92672">&lt;</span>std::io::Error<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> CustomError {
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from</span>(_: <span style="color:#a6e22e">Error</span>) -&gt; <span style="color:#a6e22e">Self</span> {
        Self::IoErr
    }
}

<span style="color:#66d9ef">impl</span> From<span style="color:#f92672">&lt;</span>ParseIntError<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> CustomError {
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from</span>(e: <span style="color:#a6e22e">ParseIntError</span>) -&gt; <span style="color:#a6e22e">Self</span> {
        Self::ParseIntError(e)
    }
}

<span style="color:#66d9ef">impl</span> From<span style="color:#f92672">&lt;</span>Utf8Error<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> CustomError {
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">from</span>(e: <span style="color:#a6e22e">Utf8Error</span>) -&gt; <span style="color:#a6e22e">Self</span> {
        Self::Utf8Error(e)
    }
}

<span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(), CustomError<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> file <span style="color:#f92672">=</span> File::open(<span style="color:#e6db74">&#34;./Cargo.toml&#34;</span>)<span style="color:#f92672">?</span>;
    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> buf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>.to_string();
    <span style="color:#66d9ef">let</span> _ <span style="color:#f92672">=</span> file.read_to_string(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> buf)<span style="color:#f92672">?</span>;

    std::<span style="color:#66d9ef">str</span>::from_utf8(<span style="color:#e6db74">&#34;😄&#34;</span>.as_bytes())<span style="color:#f92672">?</span>;
    <span style="color:#e6db74">&#34;a&#34;</span>.parse::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">i32</span><span style="color:#f92672">&gt;</span>()<span style="color:#f92672">?</span>;
    Ok(())
}
</code></pre></div></li>
</ul>
<p>以上就是我了解的错误处理方式，如果想要更深入了解，可以看看 <code>std::io::Error</code> ；</p>

    <h4><a href="https://littleguest.github.io/">Back to Home</a></h4>
</div>


        </div><footer class="container">
    <hr class="soften">
    <p>

&copy; 

    gopher9527

<span id="thisyear">2020</span>

</p>
    <p class="text-center">
        
        
        
        <a href="https://github.com/LittleGuest">GitHub</a> 
        
    </p>
</footer>

</body><link rel="stylesheet" href="/css/bootstrap.css">
<link rel="stylesheet" href="/css/bootstrap-responsive.css">
<link rel="stylesheet" href="/css/style.css">

<script src="/js/jquery.js"></script>
<script src="/js/bootstrap-386.js"></script>
<script src="/js/bootstrap-transition.js"></script>
<script src="/js/bootstrap-alert.js"></script>
<script src="/js/bootstrap-modal.js"></script>
<script src="/js/bootstrap-dropdown.js"></script>
<script src="/js/bootstrap-scrollspy.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<script src="/js/bootstrap-tooltip.js"></script>
<script src="/js/bootstrap-popover.js"></script>
<script src="/js/bootstrap-button.js"></script>
<script src="/js/bootstrap-collapse.js"></script>
<script src="/js/bootstrap-carousel.js"></script>
<script src="/js/bootstrap-typeahead.js"></script>
<script src="/js/bootstrap-affix.js"></script>
<script>
    _386 = { 
        fastLoad: false ,
        onePass: false , 
        speedFactor: 1 
    };

    
    function ThisYear() {
        document.getElementById('thisyear').innerHTML = new Date().getFullYear();
    };
</script></html>
